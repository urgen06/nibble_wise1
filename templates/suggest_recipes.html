{% extends 'base.html' %}
{% load static %}

{% block title %}Recipe Suggestions{% endblock %}

{% block content %}
<section class="max-w-6xl mx-auto px-4 py-10">
  <h1 class="text-2xl font-bold mb-6">Recipe Suggestions</h1>

  <!-- Search input -->
  <div class="mb-6 flex gap-2">
    <input type="text" id="ingredient-input" placeholder="Enter ingredients (comma-separated)"
      class="flex-1 px-4 py-2 border rounded-lg shadow-sm">
    <button id="search-btn" class="px-4 py-2 bg-brand text-white rounded-lg">Search</button>
  </div>

  <!-- Database Recipes -->
  <div id="db-section" class="mb-8">
    <h2 class="text-xl font-bold mb-2">Database Recipes</h2>
    <div id="db-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <!-- Content-Based Recommendations -->
  <div id="content-section" class="mb-8">
    <h2 class="text-xl font-bold mb-2">Content-Based Recommendations</h2>
    <div id="content-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <!-- Collaborative Recommendations -->
  <div id="collab-section" class="mb-8">
    <h2 class="text-xl font-bold mb-2">Collaborative Recommendations</h2>
    <div id="collab-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>
</section>

<script>
const searchBtn = document.getElementById('search-btn');
const input = document.getElementById('ingredient-input');

const dbResultsDiv = document.getElementById('db-results');
const contentResultsDiv = document.getElementById('content-results');
const collabResultsDiv = document.getElementById('collab-results');

// Reusable function to render any section
const renderSection = (container, items, type) => {
    container.innerHTML = '';
    if (items && items.length) {
        items.forEach(r => {
            const card = document.createElement('div');
            card.className = "bg-white rounded-xl shadow p-4";
            card.innerHTML = `
                <a href="/recipes/${r.slug}" class="block">
                    ${type === 'db' ? `<img src="${(r.photos && r.photos.length) ? r.photos[0] : '{% static "images/empty.svg" %}'}" class="h-40 w-full object-cover rounded-lg mb-2">` : ''}
                    <h3 class="font-semibold text-lg">${r.title}</h3>
                    ${type === 'db' ? `<p>${r.time || '-'} mins | ${r.difficulty || '-'}</p>` : `<p class="text-sm text-gray-600">${type} Recommendation</p>`}
                </a>
            `;
            container.appendChild(card);
        });
    } else {
        container.innerHTML = `<p>No ${type} recommendations.</p>`;
    }
};

// Event listener for search button
searchBtn.addEventListener('click', async () => {
    const query = input.value.trim();
    if (!query) return;

    // Show loading in all sections
    dbResultsDiv.innerHTML = contentResultsDiv.innerHTML = collabResultsDiv.innerHTML = '<p>Loading...</p>';

    try {
        const response = await fetch(`/suggest_recipes?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        // Render all sections
        renderSection(dbResultsDiv, data.db_recipes, 'db');
        renderSection(contentResultsDiv, data.content_based, 'Content-Based');
        renderSection(collabResultsDiv, data.collaborative, 'Collaborative');

    } catch(err) {
        dbResultsDiv.innerHTML = contentResultsDiv.innerHTML = collabResultsDiv.innerHTML = '<p class="text-red-500">Error fetching recipes</p>';
        console.error(err);
    }
});
</script>
{% endblock %}
