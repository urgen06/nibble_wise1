{% extends 'base.html' %}
{% load static %}

{% block title %}Recipe Suggestions{% endblock %}

{% block content %}
<section class="max-w-6xl mx-auto px-4 py-10">
  <h1 class="text-2xl font-bold mb-6">Recipe Suggestions</h1>

  <div class="mb-4 flex gap-2">
    <input type="text" id="ingredient-input" placeholder="Enter ingredient"
      class="flex-1 px-4 py-2 border rounded-lg shadow-sm">
    <button id="search-btn" class="px-4 py-2 bg-brand text-white rounded-lg">Search</button>
  </div>

  <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</section>

<!-- Modal for API recipe -->
<div id="api-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-lg w-full relative">
    <button id="close-modal" class="absolute top-2 right-2 text-gray-600">&times;</button>
    <h2 id="modal-title" class="text-xl font-bold mb-2"></h2>
    <h3 class="font-semibold">Ingredients:</h3>
    <p id="modal-ingredients" class="mb-2"></p>
    <h3 class="font-semibold">Instructions:</h3>
    <p id="modal-instructions" class="overflow-auto max-h-64"></p>
  </div>
</div>

<script>
const searchBtn = document.getElementById('search-btn');
const input = document.getElementById('ingredient-input');
const resultsDiv = document.getElementById('results');
const modal = document.getElementById('api-modal');
const modalTitle = document.getElementById('modal-title');
const modalIngredients = document.getElementById('modal-ingredients');
const modalInstructions = document.getElementById('modal-instructions');
const closeModal = document.getElementById('close-modal');

searchBtn.addEventListener('click', async () => {
    const query = input.value.trim();
    if (!query) return;

    resultsDiv.innerHTML = '<p>Loading...</p>';

    try {
        const response = await fetch(`/suggest_recipes?q=${query}`);
        const data = await response.json();
        resultsDiv.innerHTML = '';

        // ---------------- DB Recipes ----------------
        data.db_recipes.forEach(r => {
            const photo = r.photos.length ? r.photos[0] : '{% static "images/empty.svg" %}';
            const card = document.createElement('div');
            card.className = "bg-white rounded-xl shadow p-4";
            card.innerHTML = `
                <a href="/recipes/${r.slug}" class="block">
                    <img src="${photo}" class="h-40 w-full object-cover rounded-lg mb-2">
                    <h3 class="font-semibold text-lg">${r.title}</h3>
                    <p>${r.time} mins | ${r.difficulty}</p>
                </a>
            `;
            resultsDiv.appendChild(card);
        });

        // ---------------- API Recipes ----------------
        data.api_recipes.forEach(r => {
            const card = document.createElement('div');
            card.className = "bg-white rounded-xl shadow p-4 cursor-pointer";
            card.innerHTML = `
                <h3 class="font-semibold text-lg">${r.title}</h3>
                <p class="text-sm text-gray-600">API Recipe</p>
            `;
            card.addEventListener('click', () => {
                modalTitle.textContent = r.title;
                modalIngredients.textContent = r.ingredients;
                modalInstructions.textContent = r.instructions;
                modal.classList.remove('hidden');
            });
            resultsDiv.appendChild(card);
        });

        if(data.db_recipes.length === 0 && data.api_recipes.length === 0){
            resultsDiv.innerHTML = "<p>No recipes found for selected ingredients.</p>";
        }

    } catch(err){
        resultsDiv.innerHTML = '<p class="text-red-500">Error fetching recipes</p>';
        console.error(err);
    }
});

// Modal close
closeModal.addEventListener('click', () => {
    modal.classList.add('hidden');
});
modal.addEventListener('click', e => {
    if(e.target === modal) modal.classList.add('hidden');
});
</script>
{% endblock %}
